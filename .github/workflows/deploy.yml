name: Build and Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # 当推送到 main 分支时触发
    paths:
      - 'public/**'   # 监控 public 文件夹的变更
      - 'scripts/generateStructure.js' # 监控自动生成脚本的变更
      - 'vite.config.ts' # 监控构建配置的变更

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    - name: Set up Node.js environment
      uses: actions/setup-node@v3
      with:
        node-version: '20.17.0'  # 根据项目需要设置 Node.js 版本

    - name: Install dependencies
      run: yarn install

    # 运行代码风格检查 (Lint)
    - name: Lint code (ESLint)
      run: yarn lint  # 假设你在 package.json 中定义了 "lint" 脚本

    # 运行测试 (Jest 或其他测试工具)
    - name: Run tests
      run: yarn test  # 确保在 package.json 中定义了 "test" 脚本，或者根据你使用的测试框架修改此命令

    - name: Build the project
      run: yarn build --logLevel=info  # 启用详细日志

    - name: Preview build (check if preview works)
      run: |
        yarn preview &
        sleep 5  # 启动 preview，并等待一段时间以确保它正常运行
        curl --fail http://localhost:4173 || exit 1  # 通过 curl 请求检查服务器是否成功启动
      continue-on-error: true  # 如果预览失败，停止部署

    - name: Deploy to GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist  # 构建输出的目录